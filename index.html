<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MODE-3320 VFX | Project Deadlines</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card-container { transition: all 0.3s ease; }
        #manual-upload::file-selector-button {
            background-color: #4f46e5;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }
    </style>
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 antialiased min-h-screen">

    <div id="app" class="container mx-auto p-4 sm:p-6 md:p-8">
        <header class="relative text-center mb-8 md:mb-12">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-indigo-600 dark:text-indigo-400">MODE-3320 VFX</h1>
            <p class="text-slate-500 dark:text-slate-400 mt-2 text-base sm:text-lg">Upcoming Project Deadlines</p>
            
            <div class="mt-4">
                <p id="status-msg" class="text-xs italic text-slate-400">Fetching latest schedule...</p>
            </div>

            <button id="theme-toggle" type="button" class="absolute top-0 right-0 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 focus:outline-none focus:ring-4 focus:ring-slate-200 dark:focus:ring-slate-700 rounded-lg text-sm p-2.5">
                <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 5.05A1 1 0 003.636 6.464l.707.707a1 1 0 001.414-1.414l-.707-.707zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z"></path></svg>
            </button>
        </header>

        <main id="milestones-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 md:gap-6">
            <!-- Content populated by loadDeadlines() -->
        </main>
    </div>

    <script>
        const milestonesContainer = document.getElementById('milestones-container');
        const statusMsg = document.getElementById('status-msg');

        // --- CONFIGURATION ---
        // I have set this to your direct GitHub path to fix the refresh error.
        const FORCE_ICS_URL = "https://paulrus.github.io/3320/deadlines.ics"; 

        async function loadDeadlines() {
            const fileName = 'deadlines.ics';
            let fetchUrl = FORCE_ICS_URL || fileName;
            
            try {
                // If not forced and not a blob, try local relative path
                if (!FORCE_ICS_URL && window.location.protocol !== 'blob:') {
                    const path = window.location.pathname;
                    const directory = path.substring(0, path.lastIndexOf('/') + 1);
                    fetchUrl = `${window.location.origin}${directory}${fileName}`;
                }

                const t = new Date().getTime(); 
                const response = await fetch(`${fetchUrl}?t=${t}`, {
                    cache: 'no-store'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Failed to reach ${fetchUrl}`);
                }
                
                const content = await response.text();
                processData(content);
                statusMsg.textContent = `Last sync: ${new Date().toLocaleTimeString()}`;
            } catch (error) {
                console.error('Fetch error:', error);
                
                let errorMessage = error.message;
                if (error instanceof TypeError) {
                    errorMessage = `Network Error: Could not connect to ${fetchUrl}. This is often caused by browser security settings or a missing file on the server.`;
                }

                statusMsg.textContent = 'Connection Error: deadlines.ics not found.';
                showErrorState(errorMessage, fetchUrl);
            }
        }

        function processData(content) {
            const parsed = parseICS(content);
            renderMilestones(parsed);
        }

        function showErrorState(errorDetails, attemptedUrl) {
            milestonesContainer.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <p class="text-red-400 italic font-bold text-xl">Deadlines File Not Found</p>
                    <div class="mt-4 p-4 bg-slate-200 dark:bg-slate-800 rounded-lg inline-block text-left max-w-2xl border border-red-500/20">
                        <p class="text-xs font-bold text-slate-500 mb-2 uppercase tracking-wider">Troubleshooting Diagnostics:</p>
                        <p class="text-[10px] text-indigo-400 font-mono break-all">${errorDetails}</p>
                        <ul class="text-xs text-slate-500 mt-4 list-disc list-inside space-y-2">
                            <li>Is <b>deadlines.ics</b> uploaded to the <b>3320</b> folder on GitHub?</li>
                            <li>Does the file name match exactly (no caps)?</li>
                            <li>If you just uploaded it, wait 60 seconds for GitHub to publish the update.</li>
                        </ul>
                        <div class="mt-6 pt-4 border-t border-slate-700">
                            <p class="text-xs text-slate-400 mb-2 font-bold">Quick Test:</p>
                            <p class="text-[10px] text-slate-500 mb-2">Upload your file here to check if the code works with your data.</p>
                            <input type="file" id="manual-upload" accept=".ics" class="text-[10px]">
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('manual-upload')?.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    processData(event.target.result);
                    statusMsg.textContent = "Viewing local file (path on server still disconnected)";
                };
                reader.readAsText(file);
            });
        }

        function parseICS(data) {
            const unfoldedData = data.replace(/\r?\n[ \t]/g, '');
            const events = [];
            const veventPattern = /BEGIN:VEVENT([\s\S]*?)END:VEVENT/g;
            let match;

            while ((match = veventPattern.exec(unfoldedData)) !== null) {
                const eventContent = match[1];
                const summaryMatch = eventContent.match(/SUMMARY:(.*)/);
                let summary = summaryMatch ? summaryMatch[1].trim() : "Untitled Event";
                
                summary = summary.replace(/\\,/g, ',').replace(/\\;/g, ';').replace(/\\\\/g, '\\');

                const dtStartMatch = eventContent.match(/DTSTART(?:;VALUE=DATE)?:(\d{8}(?:T\d{6}Z?)?)/);
                
                if (dtStartMatch) {
                    const rawDate = dtStartMatch[1];
                    const year = rawDate.substring(0, 4);
                    const month = rawDate.substring(4, 6);
                    const day = rawDate.substring(6, 8);
                    
                    events.push({
                        projectName: summary.includes(':') ? summary.split(':')[0].trim() : summary,
                        milestoneName: summary.includes(':') ? summary.split(':')[1].trim() : "Deadline",
                        date: `${year}-${month}-${day}`
                    });
                }
            }
            return events;
        }

        function renderMilestones(milestones) {
            milestonesContainer.innerHTML = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const getDaysRemaining = (dateString) => {
                const [year, month, day] = dateString.split('-').map(Number);
                const targetDate = new Date(year, month - 1, day);
                const timeDiff = targetDate.getTime() - today.getTime();
                return Math.ceil(timeDiff / (1000 * 3600 * 24));
            };

            const upcoming = milestones
                .filter(m => getDaysRemaining(m.date) >= 0)
                .sort((a, b) => new Date(a.date.replace(/-/g, '/')) - new Date(b.date.replace(/-/g, '/')))
                .slice(0, 9);

            if (upcoming.length === 0) {
                milestonesContainer.innerHTML = `<p class="col-span-full text-center text-slate-500 py-12 text-xl font-bold">Great work! All projects are complete.</p>`;
                return;
            }

            upcoming.forEach((milestone, index) => {
                const days = getDaysRemaining(milestone.date);
                milestonesContainer.innerHTML += createMilestoneCard(milestone, days, index);
            });
        }

        function getColorInfo(days) {
            if (days < 5) return { colorClass: 'text-red-500 dark:text-red-400', message: 'Due Soon!' };
            if (days <= 10) return { colorClass: 'text-yellow-500 dark:text-yellow-400', message: 'days remaining' };
            const greenShade = Math.min(8, Math.floor(days / 10) + 4);
            return { colorClass: `text-green-${greenShade}00 dark:text-green-${greenShade-1}00`, message: 'days remaining' };
        }

        function createMilestoneCard(milestone, days, index) {
            const colorInfo = getColorInfo(days);
            let layoutClasses, sizeClasses;
            let numberText = (days === 0) ? '!' : days;
            
            const [year, month, day] = milestone.date.split('-').map(Number);
            const dateObj = new Date(year, month - 1, day);
            const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            
            const isFinal = milestone.milestoneName.toLowerCase().includes('final');

            if (index === 0) {
                layoutClasses = 'col-span-full md:col-span-4 lg:col-span-6';
                sizeClasses = { p: 'p-8', title: 'text-2xl', sub: 'text-base', date: 'text-sm mb-4', num: 'text-9xl', msg: 'text-lg mt-2' };
            } else if (index === 1 || index === 2) {
                layoutClasses = 'col-span-full sm:col-span-1 md:col-span-2 lg:col-span-3';
                sizeClasses = { p: 'p-6', title: 'text-xl', sub: 'text-sm', date: 'text-xs mb-3', num: 'text-7xl', msg: 'text-base mt-1' };
            } else {
                layoutClasses = 'col-span-full sm:col-span-1 md:col-span-2 lg:col-span-1';
                sizeClasses = { p: 'p-3', title: 'text-xs font-bold', sub: 'text-xs', date: 'text-[10px] mb-1', num: 'text-5xl', msg: 'text-xs' };
            }

            return `
                <div class="card-container ${layoutClasses}">
                    <div class="rounded-2xl shadow-lg flex flex-col items-center justify-center text-center h-full ${sizeClasses.p} ${isFinal ? 'bg-slate-50 dark:bg-slate-800/50 ring-1 ring-indigo-300 dark:ring-indigo-500' : 'bg-white dark:bg-slate-800'}">
                        <h2 class="font-semibold text-indigo-600 dark:text-indigo-400 ${sizeClasses.title}">${milestone.projectName}</h2>
                        <p class="text-slate-600 dark:text-slate-300 ${sizeClasses.sub}">${milestone.milestoneName}</p>
                        <p class="text-slate-400 dark:text-slate-500 ${sizeClasses.date}">${formattedDate}</p>
                        <div class="font-black ${colorInfo.colorClass} ${sizeClasses.num}">${numberText}</div>
                        <p class="text-slate-500 dark:text-slate-400 ${sizeClasses.msg}">${colorInfo.message}</p>
                    </div>
                </div>
            `;
        }

        window.onload = loadDeadlines;

        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

        function updateThemeIcons() {
            if (document.documentElement.classList.contains('dark')) {
                themeToggleLightIcon.classList.remove('hidden');
                themeToggleDarkIcon.classList.add('hidden');
            } else {
                themeToggleDarkIcon.classList.remove('hidden');
                themeToggleLightIcon.classList.add('hidden');
            }
        }

        themeToggleBtn.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            updateThemeIcons();
        });

        updateThemeIcons();
    </script>
</body>
</html>
